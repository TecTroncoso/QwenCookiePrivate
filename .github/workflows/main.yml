# .github/workflows/main.yml (VersiÃ³n Final para Koyeb)

name: Weekly Qwen Cookie Refresh & Update Koyeb

on:
  schedule:
    - cron: "0 3 * * 0" # Todos los domingos a las 3:00 AM UTC
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  refresh-and-update:
    name: Refresh Cookie and Update Koyeb Secret
    runs-on: ubuntu-latest
    environment: Qwen
    env:
      KOYEB_API_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
      KOYEB_APP_NAME: ${{ secrets.KOYEB_APP_NAME }}
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies and Tools
        run: |
          python -m pip install --upgrade pip
          # Instala xvfb para el navegador headless y jq para procesar JSON
          sudo apt-get update && sudo apt-get install -y xvfb jq
          pip install -r requirements.txt

      - name: Run Selenium Script to Get Cookies
        id: get-cookies
        run: |
          xvfb-run -a python main.py
          if [ ! -f cookies.json ]; then
            echo "::error::El archivo 'cookies.json' no fue creado."
            exit 1
          fi
          echo "âœ… Archivo 'cookies.json' generado."

      # AÃ‘ADE ESTE NUEVO PASO
      - name: Setup Koyeb CLI (Manual Install)
        run: |
          # Paso 1: Descargar la versiÃ³n especÃ­fica de la CLI
          echo "Downloading Koyeb CLI v5.7.0..."
          curl -sL "https://github.com/koyeb/koyeb-cli/releases/download/v5.7.0/koyeb-cli_5.7.0_linux_amd64.tar.gz" -o koyeb-cli.tar.gz
      
          # Paso 2: Extraer el archivo binario
          echo "Extracting CLI..."
          tar -xzf koyeb-cli.tar.gz
      
          # Paso 3: Mover el binario a una ruta del sistema para que estÃ© disponible globalmente
          # /usr/local/bin es un directorio estÃ¡ndar para esto.
          echo "Installing CLI to /usr/local/bin..."
          sudo mv koyeb /usr/local/bin/koyeb
      
          # Paso 4: Verificar la instalaciÃ³n y que el comando 'koyeb' estÃ© disponible
          echo "Verifying installation..."
          which koyeb
          koyeb version

      - name: Update Secret on Koyeb and Trigger Redeployment
        run: |
          echo "Codificando cookies a Base64..."
          B64_COOKIES=$(base64 -w 0 cookies.json)
          
          if [ -z "$B64_COOKIES" ]; then
            echo "::error::No se pudieron codificar las cookies."
            exit 1
          fi
        
          echo "Buscando el ID del servicio principal en la app '$KOYEB_APP_NAME'..."
          # Usamos el comando 'koyeb service list' para encontrar el ID de nuestro servicio.
          # Asumimos que solo hay un servicio en la app, por lo que tomamos el primero ([0]).
          SERVICE_ID=$(koyeb service list --app "$KOYEB_APP_NAME" -o json | jq -r '.[0].id')
        
          if [ -z "$SERVICE_ID" ]; then
            echo "::error:: No se pudo encontrar ningÃºn servicio en la app '$KOYEB_APP_NAME'."
            exit 1
          fi
          echo "âœ… Servicio encontrado con ID: $SERVICE_ID"
        
          echo "ðŸš€ Actualizando el secreto 'QWEN_COOKIES_JSON_B64' para el servicio..."
          # Usamos el flag correcto --service con el ID que acabamos de encontrar.
          koyeb secret update QWEN_COOKIES_JSON_B64 --value "$B64_COOKIES" --service "$SERVICE_ID"
        
          echo "âœ… Secreto actualizado. Forzando redespliegue para aplicar los cambios..."
          # Reutilizamos el SERVICE_ID para el comando de redespliegue.
          koyeb service redeploy "$SERVICE_ID"
          
          echo "âœ… Redespliegue iniciado en Koyeb. Â¡MisiÃ³n cumplida!"
